## Customer load test PoC

This branch provides is a template for running customer load tests using
the Scalyr Agent as a sidecar and sending the load to the Scalyr internal
instance, `logstaging.scalyr.com`.  The Scalyr Agent is run as
a sidecar instead of the normal DaemonSet to allow the Scalyr Agent CPU
to scale with the load generator itself.

## Clone appropriate branch

You will need to edit the provided YAML files in preparation for your
load test.  We suggest you clone the appropriate branch:

    git clone -b customer_tt git@github.com:scalyr/agent-poc.git

## Add your load generator

You will need to edit the `k8s/scalyr-sidecar.yaml` file to add in
a container that will run your load generator.  Comments in that file
show where you should insert your container definition.  If you have
any questions, please don't hesitate to reach out your Scalyr contact.

## Set up the required Kubernetes resources

Before you run the load test, you need to perform the following actions
to create the necesary Kubernetes resources.

1.  Create the Scalyr namespace.

  All resources will be created in a namespace called `scalyr`.

      kubectl create namespace scalyr

2.  Create a secret with a write logs API key from your test account.

  To obtain a write logs API key, log into the account provided to you
  by Scalyr and go to [API keys](https://logstaging.scalyr.com/keys) page.
  Copy an existing key with "Write" access in the "Log Access Keys" section.

  Then create a secret with that value:

      kubectl create secret generic scalyr-api-key --namespace=scalyr --from-literal=scalyr-api-key="<YOUR KEY>"

2.  Create the config map and service account.

      kubectl create -f k8s/configmap.yaml
      kubectl create -f k8s/scalyr-service-account.yaml


## Run the load test

To actually run the load test, be sure to edit the number of replicas in `k8s/scalyr-sidecar.yaml` to
request the appropriate number based on your target upload rate.

For 2GB/sec, we suggest 400 replicas each generating 5MB/sec of upload traffic.  Ideally, those
should be spread evenly across all nodes.

After setting the appropriate replicas value, then create the load generator deployment with the
Scalyr Agent sidecar:

    kubectl create -f k8s/scalyr-sidecar.yaml


## Additional technical details

You can, of course, use the `scalyr-sidecar.yaml` as an example for how to run the Scalyr Agent
as a sidecar in whatever application deployment you have.  Things you should note from this
example:

1.  You should use the `log.config.scalyr.com/attributes.parser` annotation to specify a parser
  for your load generator.

2. The service account used by the pod needs to be the `scalyr-service-account` OR a service account
   configured with the same permissions.  See `scalyr-service-account.yaml` for details of the
   necessary permissions.
3. The most recent build of the Scalyr Agent is `scalyr/scalyr-k8s-agent:2.1.1
4. The Kubernetes downward api needs to be used to expose environment variables to the Scalyr Agent container
5. Memory requirements under high load may increase and if memory limits are set too low, then the agent
   container will be killed.  Setting a memory request size of 80Mi and a memory limit of 150Mi should be safe values.
6. The Scalyr Agent requires various paths mapped in from the host node otherwise it won't be able
   to find the files to upload.

In order to get best throughput, it is best to have several pods generating traffic per node.

At a minimum, the following two conditions should always be true:

* You should limit the amount of logs generated by a single pod to 6 MiB/s
* You should have at least 2 log generators per node to ensure load gets evenly distributed once it hits Scalyr servers.


