## This branch provides YAML snippets for running the agent as a sidecar container rather than a DaemonSet

## Configurations and Settings

The configmap.yaml is largely unchanged from the previous test, except it now has an additional value:

    SCALYR_K8S_SIDECAR_MODE: "true"

When this value is set, the agent will only upload logs from containers in the same pod as itself.

The file `scalyr-sidecar.yaml` contains a sample deployment with necessary details.  Things to note:

1. You should configure a parser for your main container logs
2. The service account used by the pod needs to be the `scalyr-service-account` OR a service account
   configured with the same permissions.  See `scalyr-service-account.yaml` for details of the
   necessary permissions.
3. A custom build of the agent is required to run in sidecar mode.  The most recent build of this
   is `scalyr/scalyr-k8s-agent:2.0.54.sidecar_mode.1`
4. The kubernetes downward api needs to be used to expose environment variables to the scalyr agent container
5. Memory requirements under high load may increase and if memory limits are set too low, then the agent
   container will be killed.  Setting a memory request size of 60Mi and a memory limit of 150Mi should be safe values.
6. The scalyr agent requires various paths mapped in from the host node otherwise it won't be able
   to find the files to upload.

The agent doesn't need to be run as a deployment, but the spec for the Pod should look similar regardless of the controller
type used.

In order to get best throughput, it is best to have several pods generating traffic per node.

At a minimum, the following two conditions should always be true:

* You should limit the amount of logs generated by a single pod to 6 MiB/s
* You should have at least 2 log generators per node to ensure load gets evenly distributed once it hits Scalyr servers.

With respect to the various test stages, this means that at a minimum you should have the following number of generators
for each stage:

* Stage 2, target load 60 MiB/s across 10 nodes = 6 MiB/s/node = 2 generators/node each generating 3 MiB/s
* Stage 3, target load 200 MiB/s across 10 nodes = 20 MiB/s/node = 4 generators/node each generating 5 MiB/s

